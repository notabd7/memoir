<!DOCTYPE html>
<html>
<head>
    <title>Authenticating...</title>
    <!-- Load the Supabase JS library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <p>Authenticating...</p>
    
    <script>
        // Wait for DOM to be loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Hard-code the Supabase credentials directly
            // Replace these with your actual values from the .env file
            const SUPABASE_URL = "https://sjapmftvpnbczmyynbvr.supabase.co";
            const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqYXBtZnR2cG5iY3pteXluYnZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMxNDMxNTYsImV4cCI6MjA1ODcxOTE1Nn0.kEwnKxLjukkt9iknQdtuBUjUoGIxXP5tkqXdDqXpztU";
            
            console.log("Callback - Supabase URL:", SUPABASE_URL);
            console.log("Callback - Supabase Key:", SUPABASE_KEY);
            
            // Initialize Supabase client
            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            
            async function handleCallback() {
                try {
                    console.log("Handling auth callback");
                    // Get the session from the URL hash
                    const { data, error } = await supabaseClient.auth.getSession();
                    
                    console.log("Session data:", data);
                    console.log("Session error:", error);
                    
                    if (error) throw error;
                    
                    if (data && data.session) {
                        console.log("User:", data.session.user);
                        
                        // Send the session data to our backend
                        const response = await fetch('/auth', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(data.session.user)
                        });
                        
                        const result = await response.json();
                        console.log("Auth result:", result);
                        
                        if (result.error) {
                            throw new Error(result.error);
                        }
                        
                        // Redirect to dashboard
                        window.location.href = '/';
                    } else {
                        throw new Error('No session found');
                    }
                } catch (error) {
                    console.error('Auth error:', error);
                    alert('Authentication failed. Please try again: ' + error.message);
                    window.location.href = '/login';
                }
            }
            
            // Call the function when the page loads
            handleCallback();
        });
    </script>
</body>
</html>